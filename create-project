#!/bin/bash

#################################################################################
# create-project - Professional project skeleton generator
#
# A simple, fast CLI for generating new projects from battle-tested templates.
#################################################################################

set -e  # Exit on error

#################################################################################
# Colors and Formatting
#################################################################################

# Check if terminal supports colors
if command -v tput &> /dev/null && tput setaf 1 &> /dev/null; then
    BOLD=$(tput bold)
    RESET=$(tput sgr0)
    RED=$(tput setaf 1)
    GREEN=$(tput setaf 2)
    YELLOW=$(tput setaf 3)
    BLUE=$(tput setaf 4)
    MAGENTA=$(tput setaf 5)
    CYAN=$(tput setaf 6)
else
    BOLD=""
    RESET=""
    RED=""
    GREEN=""
    YELLOW=""
    BLUE=""
    MAGENTA=""
    CYAN=""
fi

#################################################################################
# Helper Functions
#################################################################################

print_banner() {
    echo ""
    echo "${CYAN}${BOLD}"
    cat << "EOF"
 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•
â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•
â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
 â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•

â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ–ˆâ–ˆâ•”â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â•  â•šâ•â•â•â•â–ˆâ–ˆâ•‘
   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘ â•šâ•â• â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘
   â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•     â•šâ•â•â•šâ•â•     â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•   â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•
EOF
    echo "${RESET}"
    echo ""
    echo "  Fast, opinionated templates for modern projects"
    echo ""
}

print_success() {
    echo "${GREEN}âœ“ $1${RESET}"
}

print_error() {
    echo "${RED}âœ— Error: $1${RESET}" >&2
}

print_warning() {
    echo "${YELLOW}âš  $1${RESET}"
}

print_info() {
    echo "${BLUE}â„¹ $1${RESET}"
}

print_step() {
    echo ""
    echo "${BOLD}${MAGENTA}â–¶ $1${RESET}"
}

spinner() {
    local pid=$1
    local message=$2
    local spinstr='â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â '
    local temp

    while kill -0 "$pid" 2>/dev/null; do
        temp=${spinstr#?}
        printf " ${CYAN}%c${RESET}  %s\r" "$spinstr" "$message"
        spinstr=$temp${spinstr%"$temp"}
        sleep 0.1
    done
    printf "    \r"
}

#################################################################################
# Validation Functions
#################################################################################

validate_project_name() {
    local name=$1

    # Check if name is empty
    if [[ -z "$name" ]]; then
        print_error "Project name cannot be empty"
        return 1
    fi

    # Check if name contains only valid characters (alphanumeric, dash, underscore)
    if [[ ! "$name" =~ ^[a-zA-Z0-9_-]+$ ]]; then
        print_error "Project name can only contain letters, numbers, dashes, and underscores"
        return 1
    fi

    # Check if directory already exists
    if [[ -d "$name" ]]; then
        print_error "Directory '$name' already exists"
        return 1
    fi

    return 0
}

#################################################################################
# Template Definitions
#################################################################################

declare -A TEMPLATES
TEMPLATES=(
    ["rails-api"]="Rails 7 API with JWT auth, Docker, Redis, Sidekiq"
    ["react-app"]="Vite + React + TypeScript + Tailwind CSS"
    ["go-microservice"]="Go microservice with Chi router and structured logging"
)

# Template order for display
TEMPLATE_ORDER=("rails-api" "react-app" "go-microservice")

#################################################################################
# Main Functions
#################################################################################

select_template() {
    print_step "Select a project template:"
    echo ""

    PS3="${BOLD}${BLUE}Enter number (1-${#TEMPLATE_ORDER[@]}): ${RESET}"

    select template_key in "${TEMPLATE_ORDER[@]}"; do
        if [[ -n "$template_key" ]]; then
            echo ""
            print_success "Selected: ${BOLD}$template_key${RESET}"
            print_info "${TEMPLATES[$template_key]}"
            SELECTED_TEMPLATE="$template_key"
            break
        else
            print_error "Invalid selection. Please choose 1-${#TEMPLATE_ORDER[@]}"
        fi
    done
}

get_project_name() {
    print_step "Enter project name:"
    echo ""

    while true; do
        read -p "${BOLD}${BLUE}Project name: ${RESET}" project_name
        echo ""

        if validate_project_name "$project_name"; then
            PROJECT_NAME="$project_name"
            break
        fi
    done
}

check_dependencies() {
    local template=$1
    local missing_deps=()

    case "$template" in
        "rails-api")
            if ! command -v docker &> /dev/null; then
                missing_deps+=("docker")
            fi
            if ! command -v docker-compose &> /dev/null && ! docker compose version &> /dev/null; then
                missing_deps+=("docker-compose")
            fi
            ;;
        "react-app")
            if ! command -v docker &> /dev/null; then
                missing_deps+=("docker")
            fi
            ;;
        "go-microservice")
            if ! command -v docker &> /dev/null; then
                missing_deps+=("docker")
            fi
            ;;
    esac

    if [[ ${#missing_deps[@]} -gt 0 ]]; then
        print_warning "Missing dependencies: ${missing_deps[*]}"
        print_info "The template will be created, but you'll need these tools to run it"
        echo ""
    fi
}

generate_project() {
    local template=$1
    local name=$2

    print_step "Generating project: ${BOLD}$name${RESET}"
    echo ""

    # Find template directory - check multiple locations
    SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
    INSTALL_TEMPLATES_DIR="$HOME/.local/share/project-skeletons"

    # Try script directory first (for local development)
    if [[ -d "$SCRIPT_DIR/$template" ]]; then
        TEMPLATE_DIR="$SCRIPT_DIR/$template"
    # Try standard install location
    elif [[ -d "$INSTALL_TEMPLATES_DIR/$template" ]]; then
        TEMPLATE_DIR="$INSTALL_TEMPLATES_DIR/$template"
    else
        print_error "Template directory not found"
        print_info "Searched locations:"
        echo "  â€¢ $SCRIPT_DIR/$template"
        echo "  â€¢ $INSTALL_TEMPLATES_DIR/$template"
        echo ""
        print_info "Try reinstalling with:"
        echo "  curl -sSL https://raw.githubusercontent.com/wyliethomas/skeletons/master/install.sh | bash"
        exit 1
    fi

    # Copy template
    print_info "Copying template files..."
    (cp -r "$TEMPLATE_DIR" "$name") &
    spinner $! "Copying files"
    print_success "Template files copied"

    # Create .env from .env.example if it exists
    if [[ -f "$name/.env.example" ]]; then
        print_info "Creating .env file..."
        cp "$name/.env.example" "$name/.env"

        # Replace COMPOSE_NAME if it's a Docker-based template
        if [[ -f "$name/.env" ]] && grep -q "COMPOSE_NAME" "$name/.env"; then
            sed -i.bak "s/COMPOSE_NAME=.*/COMPOSE_NAME=$name/" "$name/.env"
            rm -f "$name/.env.bak"
            print_success ".env file configured with project name"
        fi
    fi

    # Initialize git repository
    print_info "Initializing git repository..."
    (cd "$name" && git init -q && git add . && git commit -q -m "Initial commit from $template template") &
    spinner $! "Initializing git"
    print_success "Git repository initialized"
}

print_next_steps() {
    local template=$1
    local name=$2

    echo ""
    echo "${BOLD}${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo "${BOLD}${GREEN}  ğŸ‰  Project created successfully!${RESET}"
    echo "${BOLD}${GREEN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${RESET}"
    echo ""
    echo "${BOLD}ğŸ“ Project location:${RESET} ./$name"
    echo ""
    echo "${BOLD}ğŸš€ Next steps:${RESET}"
    echo ""
    echo "  ${CYAN}cd $name${RESET}"

    case "$template" in
        "rails-api")
            echo "  ${CYAN}./setup.sh${RESET}          # Run setup script (builds Docker, installs dependencies)"
            echo "  ${CYAN}docker compose up${RESET}   # Start the application"
            echo ""
            echo "${BOLD}ğŸ“– Quick tips:${RESET}"
            echo "  â€¢ Database runs on port 5432"
            echo "  â€¢ Redis runs on port 6379"
            echo "  â€¢ Rails server runs on http://localhost:3000"
            echo "  â€¢ Check config/application.yml.example for environment variables"
            ;;
        "react-app")
            echo "  ${CYAN}./setup.sh${RESET}          # Run setup script"
            echo "  ${CYAN}docker compose up${RESET}   # Start development server"
            echo ""
            echo "${BOLD}ğŸ“– Quick tips:${RESET}"
            echo "  â€¢ Development server runs on http://localhost:5173"
            echo "  â€¢ Hot module replacement (HMR) is enabled"
            echo "  â€¢ Edit src/App.tsx to get started"
            ;;
        "go-microservice")
            echo "  ${CYAN}make run${RESET}            # Build and run the service"
            echo "  ${CYAN}make test${RESET}           # Run tests"
            echo ""
            echo "${BOLD}ğŸ“– Quick tips:${RESET}"
            echo "  â€¢ Service runs on http://localhost:8080"
            echo "  â€¢ Check Makefile for available commands"
            echo "  â€¢ Edit cmd/server/main.go to get started"
            ;;
    esac

    echo ""
    echo "${BOLD}ğŸ“š Documentation:${RESET}"
    echo "  â€¢ Check README.md for detailed setup instructions"
    echo "  â€¢ Review CLAUDE_CONTEXT.md for architecture overview"
    echo ""
    echo "${BOLD}${GREEN}Happy coding! ğŸŠ${RESET}"
    echo ""
}

#################################################################################
# Main Script
#################################################################################

main() {
    # Print banner
    print_banner

    # Select template
    select_template

    # Get project name
    get_project_name

    # Check dependencies
    check_dependencies "$SELECTED_TEMPLATE"

    # Confirm
    echo ""
    echo "${BOLD}Summary:${RESET}"
    echo "  Template:     ${CYAN}$SELECTED_TEMPLATE${RESET}"
    echo "  Project name: ${CYAN}$PROJECT_NAME${RESET}"
    echo ""
    read -p "${BOLD}${YELLOW}Proceed? (y/n): ${RESET}" -n 1 -r
    echo ""

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_warning "Cancelled by user"
        exit 0
    fi

    # Generate project
    generate_project "$SELECTED_TEMPLATE" "$PROJECT_NAME"

    # Print next steps
    print_next_steps "$SELECTED_TEMPLATE" "$PROJECT_NAME"
}

# Run main function
main "$@"
