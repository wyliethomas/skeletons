name: Test Templates

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly to catch dependency issues
    - cron: '0 0 * * 0'

jobs:
  test-rails-api:
    name: Test Rails API Template
    runs-on: ubuntu-latest

    steps:
      - name: Checkout template branch
        uses: actions/checkout@v4
        with:
          ref: template/rails-api
          path: test-rails-api

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare template
        run: |
          cd test-rails-api
          cp .env.example .env
          sed -i 's/COMPOSE_NAME=.*/COMPOSE_NAME=test-rails-api/' .env

      - name: Build Docker images
        run: |
          cd test-rails-api
          docker compose build

      - name: Start services
        run: |
          cd test-rails-api
          docker compose up -d db redis
          sleep 10  # Wait for services to be ready

      - name: Run bundle install
        run: |
          cd test-rails-api
          docker compose run --rm web bundle install

      - name: Setup database
        run: |
          cd test-rails-api
          docker compose run --rm web rake db:create db:migrate

      - name: Run tests
        run: |
          cd test-rails-api
          docker compose run --rm web rspec || echo "Tests need to be implemented"

      - name: Check linting
        run: |
          cd test-rails-api
          docker compose run --rm web bundle exec rubocop || echo "Rubocop not configured"

      - name: Cleanup
        if: always()
        run: |
          cd test-rails-api
          docker compose down -v

  test-react-app:
    name: Test React App Template
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate project from template
        run: |
          cp -r react-app /tmp/test-react-app
          cd /tmp/test-react-app
          if [ -f .env.example ]; then
            cp .env.example .env
            sed -i 's/COMPOSE_NAME=.*/COMPOSE_NAME=test-react-app/' .env
          fi

      - name: Build Docker image
        run: |
          cd /tmp/test-react-app
          docker compose build

      - name: Install dependencies
        run: |
          cd /tmp/test-react-app
          docker compose run --rm web npm install

      - name: Run linting
        run: |
          cd /tmp/test-react-app
          docker compose run --rm web npm run lint || echo "Linting not configured"

      - name: Run tests
        run: |
          cd /tmp/test-react-app
          docker compose run --rm web npm test -- --run || echo "Tests need to be implemented"

      - name: Build production bundle
        run: |
          cd /tmp/test-react-app
          docker compose run --rm web npm run build

      - name: Check build output
        run: |
          cd /tmp/test-react-app
          if [ -d dist ]; then
            echo "✓ Build successful - dist directory created"
            ls -lh dist/
          else
            echo "✗ Build failed - dist directory not found"
            exit 1
          fi

      - name: Cleanup
        if: always()
        run: |
          cd /tmp/test-react-app
          docker compose down -v

  test-go-microservice:
    name: Test Go Microservice Template
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Generate project from template
        run: |
          cp -r go-microservice /tmp/test-go-service
          cd /tmp/test-go-service
          if [ -f .env.example ]; then
            cp .env.example .env
          fi

      - name: Build Docker image
        run: |
          cd /tmp/test-go-service
          docker build -t test-go-service .

      - name: Run tests (if Makefile exists)
        run: |
          cd /tmp/test-go-service
          if [ -f Makefile ]; then
            docker run --rm test-go-service make test || echo "Tests need to be implemented"
          fi

      - name: Check binary build
        run: |
          cd /tmp/test-go-service
          docker run --rm test-go-service go build -o /dev/null ./...
          echo "✓ Go build successful"

      - name: Cleanup
        if: always()
        run: |
          docker rmi test-go-service || true

  test-cli-script:
    name: Test CLI Script
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check script syntax
        run: |
          bash -n create-project
          echo "✓ Script syntax is valid"

      - name: Check script is executable
        run: |
          if [ -x create-project ]; then
            echo "✓ Script is executable"
          else
            echo "✗ Script is not executable"
            exit 1
          fi

      - name: Check install script syntax
        run: |
          bash -n install.sh
          echo "✓ Install script syntax is valid"

  test-documentation:
    name: Test Documentation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check required files exist
        run: |
          files=("README.md" "LICENSE" "create-project" "install.sh")
          for file in "${files[@]}"; do
            if [ -f "$file" ]; then
              echo "✓ $file exists"
            else
              echo "✗ $file is missing"
              exit 1
            fi
          done

      - name: Check template directories
        run: |
          # Check directories still on master
          templates=("react-app" "go-microservice")
          for template in "${templates[@]}"; do
            if [ -d "$template" ]; then
              echo "✓ $template directory exists"

              # Check for required files
              if [ -f "$template/README.md" ]; then
                echo "  ✓ README.md found"
              else
                echo "  ⚠ README.md missing"
              fi

              if [ -f "$template/.env.example" ]; then
                echo "  ✓ .env.example found"
              else
                echo "  ⚠ .env.example missing (might be optional)"
              fi
            else
              echo "✗ $template directory is missing"
              exit 1
            fi
          done

      - name: Check template branches exist
        run: |
          # Check template branches
          if git ls-remote --heads origin "template/rails-api" | grep -q "template/rails-api"; then
            echo "✓ template/rails-api branch exists"
          else
            echo "✗ template/rails-api branch is missing"
            exit 1
          fi

      - name: Validate markdown
        uses: actionslint/markdownlint@v1
        continue-on-error: true
        with:
          files: '**/*.md'
          config: '.markdownlint.json'

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          exit-code: '0'  # Don't fail on vulnerabilities, just report
          severity: 'CRITICAL,HIGH'

      - name: Check for secrets
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD

  all-tests-passed:
    name: All Tests Passed
    runs-on: ubuntu-latest
    needs: [test-rails-api, test-react-app, test-go-microservice, test-cli-script, test-documentation]
    if: always()

    steps:
      - name: Check all jobs status
        run: |
          if [ "${{ needs.test-rails-api.result }}" != "success" ] || \
             [ "${{ needs.test-react-app.result }}" != "success" ] || \
             [ "${{ needs.test-go-microservice.result }}" != "success" ] || \
             [ "${{ needs.test-cli-script.result }}" != "success" ] || \
             [ "${{ needs.test-documentation.result }}" != "success" ]; then
            echo "❌ Some tests failed"
            exit 1
          else
            echo "✅ All tests passed!"
          fi
